{"ast":null,"code":"import { createAction, handleActions } from \"redux-actions\";\nimport { produce } from \"immer\";\nimport firebase from \"../../shared/firebase\";\nimport \"firebase/firestore\";\nimport { firestore, storage } from \"../../shared/firebase\";\nimport \"moment\";\nimport moment from \"moment\";\nimport { actionCreators as imageActions } from \"./image\";\nconst SET_POST = \"SET_POST\";\nconst ADD_POST = \"ADD_POST\";\nconst EDIT_POST = \"EDIT_POST\";\nconst setPost = createAction(SET_POST, post_list => ({\n  post_list\n}));\nconst addPost = createAction(ADD_POST, post => ({\n  post\n}));\nconst editPost = createAction(EDIT_POST, (post_id, post) => ({\n  post_id,\n  post\n}));\nconst initialState = {\n  list: []\n};\nconst initialPost = {\n  // id: 0,\n  // user_info: {\n  //   user_name: \"joy\",\n  //   user_profile:\n  //     \"ttps://www.vmcdn.ca/f/files/piquenewsmagazine/import/2015-33_news_mtnnews2-1-cd1c0a5e13e77f75.jpg;w=640\",\n  // },\n  image_url: \"ttps://www.vmcdn.ca/f/files/piquenewsmagazine/import/2015-33_news_mtnnews2-1-cd1c0a5e13e77f75.jpg;w=640\",\n  contents: \"\",\n  comment_cnt: 0,\n  insert_dt: moment().format(\"YYY-MM-DD hh:mm:ss\")\n};\n\nconst editPostFB = (post_id = null, post = {}) => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    if (!post_id) {\n      console.log(\"게시물 정보가 없어요!\");\n      return;\n    }\n\n    const _image = getState().image.preview;\n\n    const _post_idx = getState().post.list.findIndex(p => p.id === post_id);\n\n    const _post = getState().post.list[_post_idx];\n\n    console.log(_post);\n    const postDB = firestore.collection(\"post\");\n\n    if (_image === _post.image_url) {\n      postDB.doc(post_id).update(post).then(doc => {\n        dispatch(editPost(post_id, { ...post\n        }));\n        history.replace(\"/\");\n      });\n      return;\n    } else {\n      const user_id = getState().user.user.uid;\n\n      const _upload = storage.ref(`images/${user_id}_${new Date().getTime()}`).putString(_image, \"data_url\");\n\n      _upload.then(snapshot => {\n        snapshot.ref.getDownloadURL().then(url => {\n          console.log(url);\n          return url;\n        }).then(url => {\n          postDB.doc(post_id).update({ ...post,\n            image_url: url\n          }).then(doc => {\n            dispatch(editPost(post_id, { ...post,\n              image_url: url\n            }));\n            history.replace(\"/\");\n          });\n        }).catch(err => {\n          window.alert(\"앗! 이미지 업로드에 문제가 있어요!\");\n          console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n        });\n      });\n    }\n  };\n};\n\nconst addPostFB = (contents = \"\") => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    const postDB = firestore.collection(\"post\");\n    const _user = getState().user.user;\n    const user_info = {\n      user_name: _user.user_name,\n      user_id: _user.uid,\n      user_profile: _user.user_profile\n    };\n    const _post = { ...initialPost,\n      contents: contents,\n      insert_dt: moment().format(\"YYY-MM-DD hh:mm:ss\")\n    };\n    const _image = getState().image.preview;\n    console.log(_image);\n\n    const _upload = storage.ref(`images/${user_info.user_id}_${new Date().getTime()}`).putString(_image, \"data_url\");\n\n    _upload.then(snapshot => {\n      snapshot.ref.getDownloadURL().then(url => {\n        console.log(url);\n        return url;\n      }).then(url => {\n        postDB.add({ ...user_info,\n          ..._post,\n          image_url: url\n        }).then(doc => {\n          let post = {\n            user_info,\n            ..._post,\n            id: doc.id,\n            image_url: url\n          };\n          dispatch(addPost(post));\n          history.replace(\"/\");\n          dispatch(imageActions.setPreview(null));\n        }).catch(err => {\n          window.alert(\"포스트 작성에 문제가 있어요! \");\n          console.log(\"post 작성에 실패했습니다.\", err);\n        });\n      }).catch(err => {\n        window.alert(\"이미지 업로드에 문제가 있어요! \");\n        console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n      });\n    });\n  };\n};\n\nconst getPostFB = () => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    const postDB = firestore.collection(\"post\");\n    postDB.get().then(docs => {\n      let post_list = [];\n      docs.forEach(doc => {\n        let _post = doc.data(); // ['comment_cnt', 'contents',...] 배열로 만들어 줌 \n\n\n        let post = Object.keys(_post).reduce((acc, cur) => {\n          if (cur.indexOf(\"user_\") !== -1) {\n            return { ...acc,\n              user_info: { ...acc.user_info,\n                [cur]: _post[cur]\n              }\n            };\n          }\n\n          return { ...acc,\n            [cur]: _post[cur]\n          };\n        }, {\n          id: doc.id,\n          user_info: {}\n        });\n        post_list.push(post);\n      });\n      console.log(post_list);\n      dispatch(setPost(post_list));\n    });\n  };\n}; //리듀서\n\n\nexport default handleActions({\n  [SET_POST]: (state, action) => produce(state, draft => {\n    draft.list = action.payload.post_list;\n  }),\n  [ADD_POST]: (state, action) => produce(state, draft => {\n    draft.list.unshift(action.payload.post);\n  }),\n  [EDIT_POST]: (state, action) => produce(state, draft => {\n    let idx = draft.list.findIndex(p => p.id === action.payload.post_id);\n    draft.list[idx] = { ...draft.list[idx],\n      ...action.payload.post\n    };\n  })\n}, initialState);\nconst actionCreators = {\n  setPost,\n  addPost,\n  editPost,\n  getPostFB,\n  addPostFB\n};\nexport { actionCreators };","map":{"version":3,"sources":["/Users/jeongeunchoi/REACT_MIDDLEAGE/image-community/src/redux/modules/post.js"],"names":["createAction","handleActions","produce","firebase","firestore","storage","moment","actionCreators","imageActions","SET_POST","ADD_POST","EDIT_POST","setPost","post_list","addPost","post","editPost","post_id","initialState","list","initialPost","image_url","contents","comment_cnt","insert_dt","format","editPostFB","dispatch","getState","history","console","log","_image","image","preview","_post_idx","findIndex","p","id","_post","postDB","collection","doc","update","then","replace","user_id","user","uid","_upload","ref","Date","getTime","putString","snapshot","getDownloadURL","url","catch","err","window","alert","addPostFB","_user","user_info","user_name","user_profile","add","setPreview","getPostFB","get","docs","forEach","data","Object","keys","reduce","acc","cur","indexOf","push","state","action","draft","payload","unshift","idx"],"mappings":"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","sourcesContent":["import { createAction, handleActions } from \"redux-actions\";\nimport { produce } from \"immer\";\nimport firebase from \"../../shared/firebase\";\nimport \"firebase/firestore\";\nimport { firestore, storage} from \"../../shared/firebase\";\nimport \"moment\"\nimport moment from \"moment\";\n\nimport {actionCreators as imageActions} from \"./image\";\n\n\nconst SET_POST = \"SET_POST\";\nconst ADD_POST = \"ADD_POST\";\nconst EDIT_POST = \"EDIT_POST\"\n\nconst setPost = createAction(SET_POST, (post_list) => ({ post_list }));\nconst addPost = createAction(ADD_POST, (post) => ({ post }));\nconst editPost = createAction(EDIT_POST, (post_id, post) =>({post_id, post}))\n\n\nconst initialState = {\n  list: [],\n};\n\nconst initialPost = {\n  // id: 0,\n  // user_info: {\n  //   user_name: \"joy\",\n  //   user_profile:\n  //     \"ttps://www.vmcdn.ca/f/files/piquenewsmagazine/import/2015-33_news_mtnnews2-1-cd1c0a5e13e77f75.jpg;w=640\",\n  // },\n  image_url:\n    \"ttps://www.vmcdn.ca/f/files/piquenewsmagazine/import/2015-33_news_mtnnews2-1-cd1c0a5e13e77f75.jpg;w=640\",\n  contents: \"\",\n  comment_cnt: 0,\n  insert_dt: moment().format(\"YYY-MM-DD hh:mm:ss\"),\n  \n};\n\nconst editPostFB = (post_id = null, post = {}) => {\n  return function (dispatch, getState, { history }) {\n    if (!post_id) {\n      console.log(\"게시물 정보가 없어요!\");\n      return;\n    }\n\n    const _image = getState().image.preview;\n\n    const _post_idx = getState().post.list.findIndex((p) => p.id === post_id);\n    const _post = getState().post.list[_post_idx];\n\n    console.log(_post);\n\n    const postDB = firestore.collection(\"post\");\n\n    if (_image === _post.image_url) {\n      postDB\n        .doc(post_id)\n        .update(post)\n        .then((doc) => {\n          dispatch(editPost(post_id, { ...post }));\n          history.replace(\"/\");\n        });\n\n      return;\n    } else {\n      const user_id = getState().user.user.uid;\n      const _upload = storage\n        .ref(`images/${user_id}_${new Date().getTime()}`)\n        .putString(_image, \"data_url\");\n\n      _upload.then((snapshot) => {\n        snapshot.ref\n          .getDownloadURL()\n          .then((url) => {\n            console.log(url);\n\n            return url;\n          })\n          .then((url) => {\n            postDB\n              .doc(post_id)\n              .update({ ...post, image_url: url })\n              .then((doc) => {\n                dispatch(editPost(post_id, { ...post, image_url: url }));\n                history.replace(\"/\");\n              });\n          })\n          .catch((err) => {\n            window.alert(\"앗! 이미지 업로드에 문제가 있어요!\");\n            console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n          });\n      });\n    }\n  };\n};\n\nconst addPostFB = (contents=\"\") => {\n  return function (dispatch, getState, {history}){\n\n    const postDB = firestore.collection(\"post\");\n\n    const _user = getState().user.user;\n\n    const user_info ={\n      user_name: _user.user_name,\n      user_id: _user.uid,\n      user_profile: _user.user_profile\n    };\n\n    const _post = {\n      ...initialPost,\n      contents: contents,\n      insert_dt: moment().format(\"YYY-MM-DD hh:mm:ss\"),\n\n    };\n\n    const _image = getState().image.preview;\n    console.log(_image);\n\n\n    const _upload = storage.ref(`images/${user_info.user_id}_${new Date().getTime()}`).putString(_image, \"data_url\");\n\n    _upload.then(snapshot => {\n      snapshot.ref.getDownloadURL().then(url => {\n        console.log(url);\n        \n        return url;\n      }).then(url => {\n        postDB.add({...user_info, ..._post, image_url: url }).then((doc)=>{\n      \n          let post = {user_info, ..._post, id:doc.id, image_url: url  };\n          dispatch(addPost(post));\n          history.replace(\"/\");\n\n          dispatch(imageActions.setPreview(null));\n    \n        }).catch((err) => {\n          window.alert(\"포스트 작성에 문제가 있어요! \")\n          console.log(\"post 작성에 실패했습니다.\", err);\n        });\n      }).catch((err) =>{\n        window.alert(\"이미지 업로드에 문제가 있어요! \")\n        console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n      })\n    }) \n      \n  }\n\n}\n\n\n\nconst getPostFB = () => {\n  return function (dispatch, getState, { history }) {\n    const postDB = firestore.collection(\"post\");\n\n    postDB.get().then((docs) => {\n\n        let post_list =[];\n      docs.forEach((doc) => {\n\n        let _post = doc.data();  \n        // ['comment_cnt', 'contents',...] 배열로 만들어 줌 \n        let post = Object.keys(_post).reduce((acc, cur) => {\n            \n\n            if(cur.indexOf(\"user_\") !== -1) {\n                return {...acc, user_info: {...acc.user_info, [cur]: _post[cur]}};\n            }\n            return {...acc, [cur]: _post[cur]}\n        }, {id: doc.id, user_info: {}}\n        );\n        post_list.push(post);\n      });\n\n\n      console.log(post_list);\n      dispatch(setPost(post_list));\n    });\n  };\n};\n\n//리듀서\nexport default handleActions(\n  {\n    [SET_POST]: (state, action) => produce(state, (draft) => {\n        draft.list = action.payload.post_list;\n    }),\n    [ADD_POST]: (state, action) => produce(state, (draft) => {\n     draft.list.unshift(action.payload.post);\n    }),\n    [EDIT_POST]: (state, action) => produce(state, (draft) => {\n      let idx = draft.list.findIndex((p) => p.id === action.payload.post_id)\n      draft.list[idx] = {...draft.list[idx], ...action.payload.post}\n     }),\n  },\n  initialState\n);\n\nconst actionCreators = {\n  setPost,\n  addPost,\n  editPost,\n  getPostFB,\n  addPostFB,\n\n};\n\nexport { actionCreators };\n"]},"metadata":{},"sourceType":"module"}