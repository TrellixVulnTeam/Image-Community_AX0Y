{"ast":null,"code":"import { createAction, handleActions } from \"redux-actions\";\nimport { produce } from \"immer\";\nimport { firestore, storage } from \"../../shared/firebase\";\nimport \"moment\";\nimport moment from \"moment\";\nimport { actionCreators as imageActions } from \"./image\";\nconst SET_POST = \"SET_POST\";\nconst ADD_POST = \"ADD_POST\";\nconst EDIT_POST = \"EDIT_POST\";\nconst LODING = \"LOADING\";\nconst DELETE_POST = \"DELETE_POST\";\nconst setPost = createAction(SET_POST, (post_list, paging) => ({\n  post_list,\n  paging\n}));\nconst addPost = createAction(ADD_POST, post => ({\n  post\n}));\nconst editPost = createAction(EDIT_POST, (post_id, post) => ({\n  post_id,\n  post\n}));\nconst deletePost = createAction(DELETE_POST, (post_id, post) => ({\n  post_id,\n  post\n}));\nconst loading = createAction(LODING, is_loading => ({\n  is_loading\n}));\nconst initialState = {\n  list: [],\n  paging: {\n    start: null,\n    next: null,\n    size: 3\n  },\n  is_loading: false\n};\nconst initialPost = {\n  // id: 0,\n  // user_info: {\n  //   user_name: \"mean0\",\n  //   user_profile: \"https://mean0images.s3.ap-northeast-2.amazonaws.com/4.jpeg\",\n  // },\n  image_url: \"https://mean0images.s3.ap-northeast-2.amazonaws.com/4.jpeg\",\n  contents: \"\",\n  comment_cnt: 0,\n  insert_dt: moment().format(\"YYYY-MM-DD hh:mm:ss\")\n};\n\nconst deletePostFB = (post_id = null, post = {}) => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    if (!post_id) {\n      console.log(\"게시물 정보가 없어요!\");\n      return;\n    }\n\n    const _post_idx = getState().post.list.findIndex(p => p.id === post_id);\n\n    const _post = getState().post.list[_post_idx];\n\n    const postDB = firestore.collection(\"post\");\n    postDB.doc(post_id).delete(post).then(() => {\n      dispatch(deletePost(post_id));\n      history.replace(\"/\");\n      console.log(\"포스트가 성공적으로 삭제되었습니다.\");\n    }).catch(err => {\n      console.error(\"포스트를 삭제하지 못했습니다.\", err);\n    });\n    console.log(_post);\n  };\n};\n\nconst editPostFB = (post_id = null, post = {}) => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    if (!post_id) {\n      console.log(\"게시물 정보가 없어요!\");\n      return;\n    }\n\n    const _image = getState().image.preview;\n\n    const _post_idx = getState().post.list.findIndex(p => p.id === post_id);\n\n    const _post = getState().post.list[_post_idx];\n\n    console.log(_post);\n    const postDB = firestore.collection(\"post\");\n\n    if (_image === _post.image_url) {\n      postDB.doc(post_id).update(post).then(doc => {\n        dispatch(editPost(post_id, { ...post\n        }));\n        history.replace(\"/\");\n      });\n      return;\n    } else {\n      const user_id = getState().user.user.uid;\n\n      const _upload = storage.ref(`images/${user_id}_${new Date().getTime()}`).putString(_image, \"data_url\");\n\n      _upload.then(snapshot => {\n        snapshot.ref.getDownloadURL().then(url => {\n          console.log(url);\n          return url;\n        }).then(url => {\n          postDB.doc(post_id).update({ ...post,\n            image_url: url\n          }).then(doc => {\n            dispatch(editPost(post_id, { ...post,\n              image_url: url\n            }));\n            history.replace(\"/\");\n          });\n        }).catch(err => {\n          window.alert(\"앗! 이미지 업로드에 문제가 있어요!\");\n          console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n        });\n      });\n    }\n  };\n};\n\nconst addPostFB = (contents = \"\") => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    const postDB = firestore.collection(\"post\");\n    const _user = getState().user.user;\n    const user_info = {\n      user_name: _user.user_name,\n      user_id: _user.uid,\n      user_profile: _user.user_profile\n    };\n    const _post = { ...initialPost,\n      contents: contents,\n      insert_dt: moment().format(\"YYYY-MM-DD hh:mm:ss\")\n    };\n    const _image = getState().image.preview;\n    console.log(_image);\n    console.log(typeof _image);\n\n    const _upload = storage.ref(`images/${user_info.user_id}_${new Date().getTime()}`).putString(_image, \"data_url\");\n\n    _upload.then(snapshot => {\n      snapshot.ref.getDownloadURL().then(url => {\n        console.log(url);\n        return url;\n      }).then(url => {\n        postDB.add({ ...user_info,\n          ..._post,\n          image_url: url\n        }).then(doc => {\n          let post = {\n            user_info,\n            ..._post,\n            id: doc.id,\n            image_url: url\n          };\n          dispatch(addPost(post));\n          history.replace(\"/\");\n          dispatch(imageActions.setPreview(null));\n        }).catch(err => {\n          window.alert(\"앗! 포스트 작성에 문제가 있어요!\");\n          console.log(\"post 작성에 실패했어요!\", err);\n        });\n      }).catch(err => {\n        window.alert(\"앗! 이미지 업로드에 문제가 있어요!\");\n        console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n      });\n    });\n  };\n};\n\nconst getPostFB = (start = null, size = 3) => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    // state에서 페이징 정보 가져오기\n    let _paging = getState().post.paging; // 시작정보가 기록되었는데 다음 가져올 데이터가 없다면? 앗, 리스트가 끝났겠네요!\n    // 그럼 아무것도 하지말고 return을 해야죠!\n\n    if (_paging.start && !_paging.next) {\n      return;\n    } // 가져오기 시작~!\n\n\n    dispatch(loading(true));\n    const postDB = firestore.collection(\"post\");\n    let query = postDB.orderBy(\"insert_dt\", \"desc\"); // 시작점 정보가 있으면? 시작점부터 가져오도록 쿼리 수정!\n\n    if (start) {\n      query = query.startAt(start);\n    } // 사이즈보다 1개 더 크게 가져옵시다.\n    // 3개씩 끊어서 보여준다고 할 때, 4개를 가져올 수 있으면? 앗 다음 페이지가 있겠네하고 알 수 있으니까요.\n    // 만약 4개 미만이라면? 다음 페이지는 없겠죠! :)\n\n\n    query.limit(size + 1).get().then(docs => {\n      let post_list = []; // 새롭게 페이징 정보를 만들어줘요.\n      // 시작점에는 새로 가져온 정보의 시작점을 넣고,\n      // next에는 마지막 항목을 넣습니다.\n      // (이 next가 다음번 리스트 호출 때 start 파라미터로 넘어올거예요.)\n\n      let paging = {\n        start: docs.docs[0],\n        next: docs.docs.length === size + 1 ? docs.docs[docs.docs.length - 1] : null,\n        size: size\n      };\n      docs.forEach(doc => {\n        let _post = doc.data();\n\n        let post = Object.keys(_post).reduce((acc, cur) => {\n          if (cur.indexOf(\"user_\") !== -1) {\n            return { ...acc,\n              user_info: { ...acc.user_info,\n                [cur]: _post[cur]\n              }\n            };\n          }\n\n          return { ...acc,\n            [cur]: _post[cur]\n          };\n        }, {\n          id: doc.id,\n          user_info: {}\n        });\n        post_list.push(post);\n      }); // 마지막 하나는 빼줍니다.\n      // 그래야 size대로 리스트가 추가되니까요!\n      // 마지막 데이터는 다음 페이지의 유무를 알려주기 위한 친구일 뿐! 리스트에 들어가지 않아요!\n\n      post_list.pop();\n      dispatch(setPost(post_list, paging));\n    });\n  };\n};\n\nconst getOnePostFB = id => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    const postDB = firestore.collection(\"post\");\n    postDB.doc(id).get().then(doc => {\n      let _post = doc.data();\n\n      if (!_post) {\n        return;\n      }\n\n      let post = Object.keys(_post).reduce((acc, cur) => {\n        if (cur.indexOf(\"user_\") !== -1) {\n          return { ...acc,\n            user_info: { ...acc.user_info,\n              [cur]: _post[cur]\n            }\n          };\n        }\n\n        return { ...acc,\n          [cur]: _post[cur]\n        };\n      }, {\n        id: doc.id,\n        user_info: {}\n      });\n      dispatch(setPost([post]));\n    });\n  };\n};\n\nexport default handleActions({\n  [SET_POST]: (state, action) => produce(state, draft => {\n    draft.list.push(...action.payload.post_list);\n    draft.list = draft.list.reduce((acc, cur) => {\n      if (acc.findIndex(a => a.id === cur.id) === -1) {\n        return [...acc, cur];\n      } else {\n        acc[acc.findIndex(a => a.id === cur.id)] = cur;\n        return acc;\n      }\n    }, []);\n\n    if (action.payload.paging) {\n      draft.paging = action.payload.paging;\n    }\n\n    draft.is_loading = false;\n  }),\n  [ADD_POST]: (state, action) => produce(state, draft => {\n    draft.list.unshift(action.payload.post);\n  }),\n  [EDIT_POST]: (state, action) => produce(state, draft => {\n    let idx = draft.list.findIndex(p => p.id === action.payload.post_id);\n    draft.list[idx] = { ...draft.list[idx],\n      ...action.payload.post\n    };\n  }),\n  [DELETE_POST]: (state, action) => produce(state, draft => {\n    let idx = draft.list.findIndex(p => p.id === action.payload.post_id);\n    draft.list.splice(idx);\n  }),\n  [LODING]: (state, action) => produce(state, draft => {\n    draft.is_loading = action.payload.is_loading;\n  })\n}, initialState);\nconst actionCreators = {\n  setPost,\n  addPost,\n  editPost,\n  deletePost,\n  getPostFB,\n  addPostFB,\n  editPostFB,\n  getOnePostFB,\n  deletePostFB\n};\nexport { actionCreators };","map":{"version":3,"sources":["/Users/jeongeunchoi/REACT_MIDDLEAGE/image-community/src/redux/modules/post.js"],"names":["createAction","handleActions","produce","firestore","storage","moment","actionCreators","imageActions","SET_POST","ADD_POST","EDIT_POST","LODING","DELETE_POST","setPost","post_list","paging","addPost","post","editPost","post_id","deletePost","loading","is_loading","initialState","list","start","next","size","initialPost","image_url","contents","comment_cnt","insert_dt","format","deletePostFB","dispatch","getState","history","console","log","_post_idx","findIndex","p","id","_post","postDB","collection","doc","delete","then","replace","catch","err","error","editPostFB","_image","image","preview","update","user_id","user","uid","_upload","ref","Date","getTime","putString","snapshot","getDownloadURL","url","window","alert","addPostFB","_user","user_info","user_name","user_profile","add","setPreview","getPostFB","_paging","query","orderBy","startAt","limit","get","docs","length","forEach","data","Object","keys","reduce","acc","cur","indexOf","push","pop","getOnePostFB","state","action","draft","payload","a","unshift","idx","splice"],"mappings":"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","sourcesContent":["import { createAction, handleActions } from \"redux-actions\";\nimport { produce } from \"immer\";\nimport { firestore, storage } from \"../../shared/firebase\";\nimport \"moment\";\nimport moment from \"moment\";\n\nimport { actionCreators as imageActions } from \"./image\";\n\nconst SET_POST = \"SET_POST\";\nconst ADD_POST = \"ADD_POST\";\nconst EDIT_POST = \"EDIT_POST\";\nconst LODING = \"LOADING\";\nconst DELETE_POST = \"DELETE_POST\"\n\nconst setPost = createAction(SET_POST, (post_list, paging) => ({\n  post_list,\n  paging,\n}));\nconst addPost = createAction(ADD_POST, (post) => ({ post }));\nconst editPost = createAction(EDIT_POST, (post_id, post) => ({\n  post_id,\n  post,\n}));\nconst deletePost = createAction(DELETE_POST, (post_id, post) => ({\n  post_id,\n  post,\n}));\nconst loading = createAction(LODING, (is_loading) => ({ is_loading }));\n\nconst initialState = {\n  list: [],\n  paging: { start: null, next: null, size: 3 },\n  is_loading: false,\n};\n\nconst initialPost = {\n  // id: 0,\n  // user_info: {\n  //   user_name: \"mean0\",\n  //   user_profile: \"https://mean0images.s3.ap-northeast-2.amazonaws.com/4.jpeg\",\n  // },\n  image_url: \"https://mean0images.s3.ap-northeast-2.amazonaws.com/4.jpeg\",\n  contents: \"\",\n  comment_cnt: 0,\n  insert_dt: moment().format(\"YYYY-MM-DD hh:mm:ss\"),\n};\n\n\n\nconst deletePostFB =(post_id =null, post = {}) => {\n  return function(dispatch, getState, {history}){\n\n    if(!post_id){\n      console.log(\"게시물 정보가 없어요!\")\n      return;\n    }\n    const _post_idx = getState().post.list.findIndex((p) => p.id === post_id);\n    const _post = getState().post.list[_post_idx];\n\n    const postDB = firestore.collection(\"post\");\n\n    postDB.doc(post_id).delete(post).then(() =>{\n      dispatch(deletePost(post_id));\n      history.replace(\"/\");\n      console.log(\"포스트가 성공적으로 삭제되었습니다.\")\n    }).catch((err)=>{\n      console.error(\"포스트를 삭제하지 못했습니다.\", err)\n    })\n\n    console.log(_post);\n  }\n\n}\n\nconst editPostFB = (post_id = null, post = {}) => {\n  return function (dispatch, getState, { history }) {\n    if (!post_id) {\n      console.log(\"게시물 정보가 없어요!\");\n      return;\n    }\n\n    const _image = getState().image.preview;\n\n    const _post_idx = getState().post.list.findIndex((p) => p.id === post_id);\n    const _post = getState().post.list[_post_idx];\n\n    console.log(_post);\n\n    const postDB = firestore.collection(\"post\");\n\n    if (_image === _post.image_url) {\n      postDB\n        .doc(post_id)\n        .update(post)\n        .then((doc) => {\n          dispatch(editPost(post_id, { ...post }));\n          history.replace(\"/\");\n        });\n\n      return;\n    } else {\n      const user_id = getState().user.user.uid;\n      const _upload = storage\n        .ref(`images/${user_id}_${new Date().getTime()}`)\n        .putString(_image, \"data_url\");\n\n      _upload.then((snapshot) => {\n        snapshot.ref\n          .getDownloadURL()\n          .then((url) => {\n            console.log(url);\n\n            return url;\n          })\n          .then((url) => {\n            postDB\n              .doc(post_id)\n              .update({ ...post, image_url: url })\n              .then((doc) => {\n                dispatch(editPost(post_id, { ...post, image_url: url }));\n                history.replace(\"/\");\n              });\n          })\n          .catch((err) => {\n            window.alert(\"앗! 이미지 업로드에 문제가 있어요!\");\n            console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n          });\n      });\n    }\n  };\n};\n\nconst addPostFB = (contents = \"\") => {\n  return function (dispatch, getState, { history }) {\n    const postDB = firestore.collection(\"post\");\n\n    const _user = getState().user.user;\n\n    const user_info = {\n      user_name: _user.user_name,\n      user_id: _user.uid,\n      user_profile: _user.user_profile,\n    };\n\n    const _post = {\n      ...initialPost,\n      contents: contents,\n      insert_dt: moment().format(\"YYYY-MM-DD hh:mm:ss\"),\n    };\n\n    const _image = getState().image.preview;\n\n    console.log(_image);\n    console.log(typeof _image);\n\n    const _upload = storage\n      .ref(`images/${user_info.user_id}_${new Date().getTime()}`)\n      .putString(_image, \"data_url\");\n\n    _upload.then((snapshot) => {\n      snapshot.ref\n        .getDownloadURL()\n        .then((url) => {\n          console.log(url);\n\n          return url;\n        })\n        .then((url) => {\n          postDB\n            .add({ ...user_info, ..._post, image_url: url })\n            .then((doc) => {\n              let post = { user_info, ..._post, id: doc.id, image_url: url };\n              dispatch(addPost(post));\n              history.replace(\"/\");\n\n              dispatch(imageActions.setPreview(null));\n            })\n            .catch((err) => {\n              window.alert(\"앗! 포스트 작성에 문제가 있어요!\");\n              console.log(\"post 작성에 실패했어요!\", err);\n            });\n        })\n        .catch((err) => {\n          window.alert(\"앗! 이미지 업로드에 문제가 있어요!\");\n          console.log(\"앗! 이미지 업로드에 문제가 있어요!\", err);\n        });\n    });\n  };\n};\n\nconst getPostFB = (start = null, size = 3) => {\n  return function (dispatch, getState, { history }) {\n    // state에서 페이징 정보 가져오기\n    let _paging = getState().post.paging;\n\n    // 시작정보가 기록되었는데 다음 가져올 데이터가 없다면? 앗, 리스트가 끝났겠네요!\n    // 그럼 아무것도 하지말고 return을 해야죠!\n    if (_paging.start && !_paging.next) {\n      return;\n    }\n\n    // 가져오기 시작~!\n    dispatch(loading(true));\n\n    const postDB = firestore.collection(\"post\");\n\n    let query = postDB.orderBy(\"insert_dt\", \"desc\");\n\n    // 시작점 정보가 있으면? 시작점부터 가져오도록 쿼리 수정!\n    if (start) {\n      query = query.startAt(start);\n    }\n\n    // 사이즈보다 1개 더 크게 가져옵시다.\n    // 3개씩 끊어서 보여준다고 할 때, 4개를 가져올 수 있으면? 앗 다음 페이지가 있겠네하고 알 수 있으니까요.\n    // 만약 4개 미만이라면? 다음 페이지는 없겠죠! :)\n    query\n      .limit(size + 1)\n      .get()\n      .then((docs) => {\n        let post_list = [];\n\n        // 새롭게 페이징 정보를 만들어줘요.\n        // 시작점에는 새로 가져온 정보의 시작점을 넣고,\n        // next에는 마지막 항목을 넣습니다.\n        // (이 next가 다음번 리스트 호출 때 start 파라미터로 넘어올거예요.)\n        let paging = {\n          start: docs.docs[0],\n          next:\n            docs.docs.length === size + 1\n              ? docs.docs[docs.docs.length - 1]\n              : null,\n          size: size,\n        };\n\n        docs.forEach((doc) => {\n          let _post = doc.data();\n\n          let post = Object.keys(_post).reduce(\n            (acc, cur) => {\n              if (cur.indexOf(\"user_\") !== -1) {\n                return {\n                  ...acc,\n                  user_info: { ...acc.user_info, [cur]: _post[cur] },\n                };\n              }\n              return { ...acc, [cur]: _post[cur] };\n            },\n            { id: doc.id, user_info: {} }\n          );\n\n          post_list.push(post);\n        });\n\n        // 마지막 하나는 빼줍니다.\n        // 그래야 size대로 리스트가 추가되니까요!\n        // 마지막 데이터는 다음 페이지의 유무를 알려주기 위한 친구일 뿐! 리스트에 들어가지 않아요!\n        post_list.pop();\n\n        dispatch(setPost(post_list, paging));\n      });\n  };\n};\n\nconst getOnePostFB = (id) => {\n  return function (dispatch, getState, { history }) {\n    const postDB = firestore.collection(\"post\");\n    postDB\n      .doc(id)\n      .get()\n      .then((doc) => {\n        let _post = doc.data();\n\n        if (!_post) {\n          return;\n        }\n\n        let post = Object.keys(_post).reduce(\n          (acc, cur) => {\n            if (cur.indexOf(\"user_\") !== -1) {\n              return {\n                ...acc,\n                user_info: { ...acc.user_info, [cur]: _post[cur] },\n              };\n            }\n            return { ...acc, [cur]: _post[cur] };\n          },\n          { id: doc.id, user_info: {} }\n        );\n\n        dispatch(setPost([post]));\n      });\n  };\n};\n\nexport default handleActions(\n  {\n    [SET_POST]: (state, action) =>\n      produce(state, (draft) => {\n        draft.list.push(...action.payload.post_list);\n        draft.list = draft.list.reduce((acc, cur) => {\n          if (acc.findIndex((a) => a.id === cur.id) === -1) {\n            return [...acc, cur];\n          } else {\n            acc[acc.findIndex((a) => a.id === cur.id)] = cur;\n            return acc;\n          }\n        }, []);\n\n        if (action.payload.paging) {\n          draft.paging = action.payload.paging;\n        }\n\n        draft.is_loading = false;\n      }),\n\n    [ADD_POST]: (state, action) =>\n      produce(state, (draft) => {\n        draft.list.unshift(action.payload.post);\n      }),\n    [EDIT_POST]: (state, action) =>\n      produce(state, (draft) => {\n        let idx = draft.list.findIndex((p) => p.id === action.payload.post_id);\n\n        draft.list[idx] = { ...draft.list[idx], ...action.payload.post };\n      }),\n      [DELETE_POST]: (state, action) =>\n      produce(state, (draft) => {\n        let idx = draft.list.findIndex((p) => p.id === action.payload.post_id);\n\n        draft.list.splice(idx)\n      }),\n\n\n    [LODING]: (state, action) =>\n      produce(state, (draft) => {\n        draft.is_loading = action.payload.is_loading;\n      }),\n  },\n  initialState\n);\n\nconst actionCreators = {\n  setPost,\n  addPost,\n  editPost,\n  deletePost,\n  getPostFB,\n  addPostFB,\n  editPostFB,\n  getOnePostFB,\n  deletePostFB,\n};\n\nexport { actionCreators };\n"]},"metadata":{},"sourceType":"module"}